<div class="exchange">
  <!-- Barra tipo ticker -->
  <div class="ticker">
    <div class="pair">{{ currentUsername ? (currentUsername + ' • fondos') : 'Tus fondos' }}</div>
    <div class="last">{{ totalBalance | number:'1.4-4' }} SIM</div>
    <div class="change">
      ≈ {{ holdingsUsd !== null ? (holdingsUsd | number:'1.2-2') : '—' }} USD
    </div>
    <button class="btn outline refresh" type="button" (click)="loadMetrics()" [disabled]="loadingMetrics">
      {{ loadingMetrics ? 'Actualizando…' : 'Actualizar' }}
    </button>
  </div>

  <!-- Grid principal: izquierda / centro / derecha -->
  <div class="market-grid">
    <!-- Aviso bienvenida -->
    <section *ngIf="welcomeBanner" class="panel notice" style="grid-column: 1 / -1;">
      <strong>Bienvenido</strong>
      <div class="muted">Se creó tu wallet por defecto y se acreditaron 5 SIM de cortesía.</div>
    </section>
    <!-- Columna izquierda: resumen de cuenta -->
    <section class="panel account">
      <h3>Cuenta</h3>
      <div class="kpis">
        <div class="kpi"><span>Saldo confirmado</span><strong>{{ totalBalance | number:'1.4-4' }} SIM</strong></div>
        <div class="kpi"><span>Wallets</span><strong>{{ walletsCount ?? 0 }}</strong></div>
        <div class="kpi"><span>Tx pend.</span><strong>{{ pendingCount }}</strong></div>
        <div class="kpi"><span>Tx conf.</span><strong>{{ confirmedCount }}</strong></div>
      </div>
      <div class="assets">
        <table *ngIf="walletSummaries.length" class="table compact">
          <thead><tr><th>Wallet</th><th>Balance</th></tr></thead>
          <tbody>
            <tr *ngFor="let item of walletSummaries">
              <td>{{ item.wallet.name }} (#{{ item.wallet.id }})</td>
              <td>{{ item.balance | number:'1.4-4' }}</td>
            </tr>
          </tbody>
        </table>
        <p class="muted" *ngIf="!walletSummaries.length">Sin wallets. Crea una en Wallets.</p>
        <a class="btn wfull" routerLink="/wallets">Ir a Wallets</a>
      </div>
    </section>

    <!-- Columna central: gráfico principal + acciones rápidas -->
    <section class="panel chart">
      <div class="panel__header">
        <h3>SIM / USD</h3>
        <div class="price-inline">
          <strong>{{ lastPrice ? (lastPrice | number:'1.2-6') : '—' }}</strong>
          <span class="pill" [class.success]="(priceChangePct||0) >= 0" [class.danger]="(priceChangePct||0) < 0">
            {{ priceChangePct !== null ? (priceChangePct | number:'1.2-2') + '%' : '—' }}
          </span>
        </div>
      </div>
      <div class="chart__wrap">
        <canvas id="activityChart"></canvas>
        <div class="skeleton" *ngIf="loadingMetrics && !priceSeries.length"></div>
      </div>
      <div class="quick-actions">
        <a class="btn primary" routerLink="/txs">Nueva transacción</a>
        <a class="btn" routerLink="/blocks">Minar bloque</a>
        <a class="btn outline" routerLink="/price">Precio</a>
        <a class="btn outline" routerLink="/audit">Audit</a>
      </div>
      <p class="muted" *ngIf="!priceSeries.length">Registra precios para ver el gráfico.</p>
    </section>

    <!-- Columna derecha: actividad -->
    <section class="panel activity">
      <h3>Actividad</h3>
      <!-- Notificaciones: ahora se muestran como icono en el topbar -->
      <h4 class="sub">Transacciones recientes</h4>
      <table *ngIf="visibleTransactions.length" class="table compact">
        <thead><tr><th>ID</th><th>Desde → Hacia</th><th>Monto</th><th>Estado</th></tr></thead>
        <tbody>
          <tr *ngFor="let tx of visibleTransactions">
            <td>#{{ tx.id }}</td>
            <td>
              <div>@{{ tx.from_username || '—' }} → @{{ tx.to_username || '—' }}</div>
              <small class="muted">{{ tx.from_wallet_name }} → {{ tx.to_wallet_name }}</small>
            </td>
            <td>{{ tx.amount }}</td>
            <td><span class="status" [class.pending]="tx.status==='PENDING'" [class.confirmed]="tx.status==='CONFIRMED'" [class.failed]="tx.status==='FAILED'">{{ tx.status }}</span></td>
          </tr>
        </tbody>
      </table>
      <p class="muted" *ngIf="!recentTransactions.length">Sin actividad aún.</p>

      

      <h4 class="sub">Usuarios</h4>
      <table *ngIf="users.length" class="table compact">
        <thead><tr><th>ID</th><th>Usuario</th></tr></thead>
        <tbody>
          <tr *ngFor="let u of users">
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
          </tr>
        </tbody>
      </table>
      <p class="muted" *ngIf="!users.length">Sin usuarios registrados.</p>
    </section>
  </div>

  <!-- Accesos (parte inferior) -->
  <section class="card hub" aria-label="Accesos rápidos">
    <div class="hub__grid">
      <a class="tile" routerLink="/wallets"><h4>Wallets</h4><p class="muted">Administra tus billeteras</p><span class="pill">{{ walletsCount ?? 0 }}</span></a>
      <a class="tile" routerLink="/txs"><h4>Transacciones</h4><p class="muted">Envíos, recibos, fees</p><span class="pill">{{ txCount ?? 0 }}</span></a>
      <a class="tile" routerLink="/blocks"><h4>Bloques</h4><p class="muted">Altura, merkle root</p><span class="pill">{{ blockCount ?? 0 }}</span></a>
      <a class="tile" routerLink="/trade"><h4>Trade</h4><p class="muted">Comprar / Vender SIM</p><span class="pill">Go</span></a>
      <a class="tile" routerLink="/price"><h4>Precio</h4><p class="muted">Serie SIM/USD</p><span class="pill">{{ lastPrice ? (lastPrice | number:'1.2-2') : '—' }}</span></a>
      <a class="tile" routerLink="/audit"><h4>Audit Log</h4><p class="muted">Acciones del sistema</p><span class="pill">{{ auditCount ?? 0 }}</span></a>
    </div>
  </section>
</div>
