<section class="feature-center">
  <div class="feature-card">
    <h2>Transacciones</h2>

    <div *ngIf="fromWalletId" class="callout">
      <strong>Preparar transferencia</strong>
      <div class="muted small">
        Wallet origen: #{{ fromWalletId }}
        <span *ngIf="fromPubKey"> — <code>{{ fromPubKey }}</code></span>
      </div>
      <p class="muted">Los campos se completaron con esta wallet.</p>
    </div>

    <form class="transfer" (submit)="$event.preventDefault(); create();">
      <div class="field">
        <label>Wallet emisora</label>
        <select [(ngModel)]="form.from_wallet" name="from_wallet">
          <option *ngFor="let w of wallets" [ngValue]="w.id">{{ w.name }} (#{{ w.id }})</option>
        </select>
      </div>
      <div class="field">
        <label>Usuario destino</label>
        <select [(ngModel)]="form.to_user" name="to_user">
          <option [ngValue]="null">— Seleccionar usuario —</option>
          <option *ngFor="let u of users" [ngValue]="u.id">{{ u.username }} (#{{ u.id }})</option>
        </select>
        <small class="muted">Se enviará a la wallet por defecto del usuario seleccionado.</small>
      </div>
      <div class="field">
        <label>ID wallet destino (opcional)</label>
        <input type="number" [(ngModel)]="form.to_wallet" name="to_wallet" placeholder="ID numérico" />
        <small class="muted">Si no eliges usuario, puedes especificar un ID de wallet.</small>
      </div>
      <div class="field double">
        <div>
          <label>Monto (SIM)</label>
          <input type="number" step="0.00000001" [(ngModel)]="form.amount" name="amount" />
        </div>
        <div>
          <label>Fee</label>
          <input type="number" step="0.00000001" [(ngModel)]="form.fee" name="fee" />
        </div>
      </div>
      <button class="btn primary" type="submit" [disabled]="sending">{{ sending ? 'Enviando...' : 'Enviar' }}</button>
    </form>

    <section class="filters">
      <div class="field">
        <label>Filtrar por estado</label>
        <select [(ngModel)]="statusFilter" name="statusFilter" (change)="applyFilters()">
          <option value="ALL">Todos</option>
          <option value="PENDING">Pendientes</option>
          <option value="CONFIRMED">Confirmadas</option>
          <option value="FAILED">Fallidas</option>
        </select>
      </div>
      <div class="field">
        <label>Filtrar por wallet</label>
        <select [(ngModel)]="walletFilter" name="walletFilter" (change)="applyFilters()">
          <option [ngValue]="null">Todas</option>
          <option *ngFor="let w of wallets" [ngValue]="w.id">{{ w.name }} (#{{ w.id }})</option>
        </select>
      </div>
    </section>

    <div *ngIf="success" class="success">
      <div>
        <strong>Transacción enviada</strong>
        <div class="muted small">TX hash: {{ success.tx_hash }}</div>
        <div class="muted small">#{{ success.from_wallet }} → #{{ success.to_wallet }} · {{ success.amount }} SIM</div>
      </div>
      <button type="button" class="btn" (click)="dismissSuccess()">Cerrar</button>
    </div>

    <div *ngIf="error" class="error">{{ error }}</div>

    <div *ngIf="loading" class="skeleton-list"><div class="skeleton-row" *ngFor="let _ of [1,2,3,4,5]"></div></div>

    <table *ngIf="!loading && transactions.length" class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Desde</th>
          <th>Hacia</th>
          <th>Monto</th>
          <th>Fee</th>
          <th>Estado</th>
          <th>Block</th>
          <th>Acciones</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let tx of transactions">
          <td>#{{ tx.id }}</td>
          <td>
            <div>{{ tx.from_wallet_name }} (#{{ tx.from_wallet }})</div>
            <small class="muted">@{{ tx.from_username || '—' }} (user #{{ tx.from_user || '—' }})</small>
            <small class="muted">hash: {{ tx.tx_hash | slice:0:12 }}…</small>
          </td>
          <td>
            <div>{{ tx.to_wallet_name || '-' }} (#{{ tx.to_wallet }})</div>
            <small class="muted">@{{ tx.to_username || '—' }} (user #{{ tx.to_user || '—' }})</small>
          </td>
          <td>{{ tx.amount }}</td>
          <td>{{ tx.fee }}</td>
          <td><span class="status" [class.pending]="tx.status==='PENDING'" [class.confirmed]="tx.status==='CONFIRMED'" [class.failed]="tx.status==='FAILED'">{{ tx.status }}</span></td>
          <td>{{ tx.block ?? '—' }}</td>
          <td>
            <ng-container *ngIf="tx.status==='PENDING'; else noActions">
              <select [(ngModel)]="confirmBlockId[tx.id]" name="block_{{tx.id}}" [disabled]="sending">
                <option *ngFor="let b of blocks" [ngValue]="b.id">#{{ b.id }} (h={{ b.height }})</option>
              </select>
              <button class="btn small" type="button" (click)="confirmTx(tx)" [disabled]="sending || !blocks.length">Confirmar</button>
              <button class="btn small outline" type="button" (click)="failTx(tx)" [disabled]="sending">Fallar</button>
            </ng-container>
            <ng-template #noActions>—</ng-template>
          </td>
          <td>{{ tx.created_at | date:'medium' }}</td>
        </tr>
      </tbody>
    </table>

    <p class="muted" *ngIf="!loading && !transactions.length">Aún no hay transacciones.</p>
  </div>
</section>
